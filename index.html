<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VÅ« Studio Watchdog</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='36' height='30' viewBox='0 0 36 30' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M18.3198 -0.000183105C17.7276 -0.000183105 17.1081 0.126923 16.6045 0.381737L1.91738 7.79744C1.42201 8.0475 1.06801 8.4021 0.860711 8.81194C0.718752 9.09408 0.647476 9.38809 0.647476 9.68567C0.647476 9.98325 0.718158 10.2773 0.860711 10.56C1.06801 10.9692 1.42201 11.3238 1.91738 11.5739L16.6045 18.9896C17.1075 19.2438 17.7276 19.3715 18.3198 19.3715C18.912 19.3715 19.5315 19.2438 20.0352 18.9896L34.7223 11.5739C35.2177 11.3238 35.5717 10.9692 35.779 10.56C35.9215 10.2773 35.9928 9.98325 35.9928 9.68567C35.9928 9.38749 35.9209 9.09348 35.779 8.81194C35.5723 8.4021 35.2183 8.0481 34.7223 7.79744L20.0352 0.381737C19.5315 0.126923 18.912 -0.000183105 18.3198 -0.000183105ZM17.9878 16.2478L4.99177 9.68567L17.9878 3.1235C18.0466 3.0932 18.1696 3.07836 18.3198 3.07836C18.4701 3.07836 18.5931 3.0932 18.6519 3.1235L31.6479 9.68567L18.6519 16.2478C18.5931 16.2781 18.4701 16.293 18.3198 16.293C18.1702 16.293 18.0472 16.2775 17.9878 16.2478ZM0.80369 15.0575C0.693805 15.2755 0.640942 15.5078 0.63916 15.7364V15.7602C0.643318 16.3173 0.952182 16.8525 1.48378 17.1204L14.8831 23.8869C15.9303 24.4155 17.1271 24.6798 18.3198 24.6798V24.6858C19.5048 24.6858 20.7017 24.4197 21.7565 23.8869L35.1559 17.1204C35.9132 16.7391 36.2179 15.8148 35.836 15.0581C35.4535 14.3008 34.5304 13.9967 33.7731 14.3786L20.3732 21.1451C19.7632 21.4528 19.0474 21.6072 18.3198 21.6072V21.6138C17.5999 21.6138 16.8842 21.4569 16.2665 21.1451L2.86654 14.3786C2.64499 14.267 2.40859 14.2135 2.17576 14.2135C1.61446 14.2135 1.07395 14.5224 0.80369 15.0575ZM33.7731 20.1449L22.0945 26.0412C20.9339 26.628 19.6301 26.9215 18.3198 26.9215V26.9274C17.0167 26.9274 15.7141 26.6322 14.5452 26.0412L2.86654 20.1449C2.10923 19.7629 1.18621 20.0671 0.80369 20.8244C0.693805 21.0424 0.640942 21.274 0.63916 21.5027V21.5264C0.643318 22.0836 0.952182 22.6187 1.48378 22.8872L13.1618 28.7836C14.7596 29.5908 16.5397 29.9941 18.3198 29.9941V30C20.0922 30 21.8724 29.5949 23.4779 28.7836L35.1559 22.8872C35.9132 22.5053 36.2179 21.5817 35.836 20.8244C35.5657 20.2886 35.0246 19.9797 34.4633 19.9797C34.2311 19.9797 33.9947 20.0326 33.7731 20.1449Z' fill='%2322c55e'/%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.3.1/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    *::-webkit-scrollbar { width: 0; }
    * { scrollbar-width: none; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
      padding: 24px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #262626;
    }
    .header h1 { font-size: 20px; font-weight: 600; color: #fafafa; }
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #a3a3a3;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #dc2626;
    }
    .status-dot.connected {
      background: #22c55e;
      box-shadow: 0 0 6px #22c55e66;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .controls label { font-size: 13px; color: #a3a3a3; }
    .controls input, .controls button, .controls select {
      background: #171717;
      border: 1px solid #333;
      color: #e5e5e5;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }
    .controls input:focus, .controls select:focus { border-color: #525252; }
    .controls button {
      cursor: pointer;
      background: #262626;
      font-weight: 500;
      transition: background 0.15s;
    }
    .controls button:hover { background: #333; }
    .controls button.active {
      background: #22c55e;
      color: #000;
      border-color: #22c55e;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #141414;
      border: 1px solid #262626;
      border-radius: 10px;
      padding: 20px;
    }
    .card-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #737373;
      margin-bottom: 16px;
    }
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
    }
    .metric-label { font-size: 13px; color: #a3a3a3; }
    .metric-value {
      font-size: 13px;
      font-weight: 600;
      color: #fafafa;
      font-variant-numeric: tabular-nums;
    }
    .metric-value.warn { color: #f59e0b; }
    .metric-value.danger { color: #ef4444; }
    .metric-value.good { color: #22c55e; }
    .bar-container {
      width: 100%;
      height: 6px;
      background: #262626;
      border-radius: 3px;
      margin-top: 4px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease, background 0.3s;
    }
    .big-value {
      font-size: 36px;
      font-weight: 700;
      color: #fafafa;
      font-variant-numeric: tabular-nums;
    }
    .big-unit {
      font-size: 14px;
      font-weight: 400;
      color: #737373;
      margin-left: 4px;
    }
    .chart-card {
      background: #141414;
      border: 1px solid #262626;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .chart-container {
      position: relative;
      height: 200px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .log-container {
      background: #141414;
      border: 1px solid #262626;
      border-radius: 10px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
    }
    .log-entry {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px;
      color: #737373;
      padding: 3px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: #525252; }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #525252;
    }
    .empty-state p { font-size: 14px; margin-top: 8px; }
    .data-points {
      font-size: 11px;
      color: #525252;
      font-variant-numeric: tabular-nums;
    }

    /* Health Mode Banner */
    .health-banner {
      display: none;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      border: 1px solid;
    }
    .health-banner .conditions {
      font-weight: 400;
      font-size: 12px;
      margin-top: 4px;
      opacity: 0.85;
    }
    .health-banner.mode-READY { background: #052e16; color: #22c55e; border-color: #166534; }
    .health-banner.mode-STARTING { background: #172554; color: #60a5fa; border-color: #1e40af; }
    .health-banner.mode-DEGRADED { background: #451a03; color: #f59e0b; border-color: #92400e; }
    .health-banner.mode-CRITICAL { background: #450a0a; color: #ef4444; border-color: #991b1b; }
    .health-banner.mode-SHUTTING_DOWN { background: #1c1917; color: #a8a29e; border-color: #44403c; }

    /* Events Panel */
    .event-entry {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 11px;
      padding: 4px 0;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .event-entry:last-child { border-bottom: none; }
    .event-severity {
      font-weight: 700;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .event-severity.sev-INFO { background: #172554; color: #60a5fa; }
    .event-severity.sev-WARN { background: #451a03; color: #f59e0b; }
    .event-severity.sev-ERROR { background: #450a0a; color: #ef4444; }
    .event-severity.sev-CRITICAL { background: #7f1d1d; color: #fca5a5; }
    .event-type { color: #e5e5e5; font-weight: 600; }
    .event-details { color: #737373; font-size: 10px; }
    .event-time { color: #525252; flex-shrink: 0; }

    /* Lease Indicator */
    .lease-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 6px;
      background: #171717;
      border: 1px solid #333;
      color: #a3a3a3;
    }
    .lease-indicator.active { border-color: #f59e0b; color: #f59e0b; }

    /* Ack feedback */
    .ack-status {
      font-size: 11px;
      margin-left: 6px;
      font-weight: 500;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex;align-items:center;gap:16px;">
      <svg viewBox="23.04 105.83999999999999 674.64 151.92" xmlns="http://www.w3.org/2000/svg" height="24" style="flex-shrink:0;"><defs><style>.st0{fill:#fff;}</style></defs><path d="M169.3,156.6l-57.1-28.8c-.2-.1-.8-.2-1.4-.2s-1.2.1-1.4.2l-57.2,28.8,57.1,28.8c.2.1.8.2,1.4.2s1.2-.1,1.4-.2l57.2-28.8ZM118.3,115.7l64.5,32.6c2.2,1.1,3.7,2.6,4.7,4.4.6,1.2,1,2.5,1,3.8s-.4,2.6-1,3.8c-1,1.8-2.5,3.4-4.7,4.4l-64.5,32.6c-2.2,1.1-4.9,1.7-7.5,1.7s-5.4-.6-7.5-1.7l-64.5-32.6c-2.2-1.1-3.7-2.6-4.7-4.4-.6-1.2-1-2.5-1-3.8s.4-2.6,1-3.8c1-1.8,2.5-3.4,4.7-4.4l64.5-32.6c2.2-1.1,4.9-1.7,7.5-1.7s5.3.6,7.5,1.7ZM178.7,177.2c3.4-1.7,7.4-.4,9.1,3,1.7,3.4.4,7.4-3,9.1l-59,29.8c-4.7,2.4-9.9,3.5-15.1,3.5h0c-5.3,0-10.5-1.2-15.1-3.5l-58.9-29.8c-3.4-1.7-4.7-5.7-3-9.1,1.7-3.4,5.7-4.7,9.1-3l58.9,29.8c2.8,1.3,5.9,2,9,2h0c3.2,0,6.3-.7,9-2l59-29.8ZM178.7,202.6c3.4-1.7,7.4-.4,9.1,3,1.7,3.4.4,7.4-3,9.1l-51.3,26c-7.1,3.6-14.8,5.4-22.6,5.4h0c-7.8,0-15.7-1.8-22.6-5.3l-51.3-26c-3.4-1.7-4.7-5.7-3-9.1s5.7-4.7,9.1-3l51.3,26c5.1,2.6,10.9,3.9,16.6,3.9h0c5.7,0,11.5-1.3,16.6-3.8l51.1-26.2Z" class="st0"/><g><g><polygon points="217.3 142.4 236.3 142.4 259.2 196 282.3 142.4 299.8 142.4 266.7 219.2 250.3 219.2 217.3 142.4" class="st0"/><path d="M300.3,163.1h16.3s0,19.3,0,28.7c0,2.4,0,14,11.2,14s13-9.7,13-13.3c0-9.6,0-29.4,0-29.4h16.4v56h-15.6v-6.5s-4.6,7.5-17.5,7.5-12.6-1.7-17.6-6.7c-5.6-5.5-6.2-14.5-6.2-17.5,0-10.7,0-32.8,0-32.8Z" class="st0"/><polygon points="301.3 154.6 306.4 142.4 357.2 142.4 357.2 154.6 301.3 154.6" class="st0"/></g><path d="M522.5,201.7c-1.8,3.3-5.1,4.9-10,4.9s-7.5-2.7-7.5-8.3v-35.1h-16.6v35.5c0,6.9,1.8,12.3,5.1,15.9,3.3,3.7,8.2,5.5,14.5,5.5s11.3-2,15.1-5.9l.4,4.9h15.7v-55.9h-16.7v38.4Z" class="st0"/><path d="M479,206.3c-2.1,0-3.5-.4-4.2-1.2-.7-.8-1.1-2.2-1.1-4.1v-27.9h9.8v-9.9h-9.8v-16.7h-16.6v16.7h-8.4v9.9h8.4v30.2c.2,11.2,6,16.9,17.1,16.9s6.4-.5,9.5-1.4h.5v-13h-.8c-1.3.4-2.7.5-4.4.5Z" class="st0"/><path d="M616.5,141.1c-2.8,0-5.1.8-6.7,2.4-1.7,1.6-2.5,3.7-2.5,6.1s.9,4.6,2.6,6.2c1.7,1.6,3.9,2.4,6.7,2.4s5-.8,6.7-2.4c1.7-1.6,2.6-3.7,2.6-6.2s-.9-4.5-2.5-6.1c-1.7-1.6-3.9-2.4-6.7-2.4Z" class="st0"/><path d="M431.6,142.8c-4.4-2-9.4-3.1-15-3.1s-10.6.9-15,2.8c-4.5,1.9-8,4.5-10.4,7.9-2.4,3.4-3.6,7.2-3.6,11.5,0,8.2,4.5,14.9,13.5,19.7,3.2,1.7,7.7,3.5,13.2,5.3,5.4,1.8,9.2,3.4,11.2,5,2,1.5,2.9,3.6,2.9,6.4s-.9,4.5-2.9,5.9c-2,1.4-4.8,2.2-8.5,2.2-9.8,0-14.6-4-14.6-12.1v-.7h-17.2v.7c0,5.1,1.3,9.6,3.9,13.5,2.6,3.9,6.5,6.9,11.4,9.1,4.9,2.2,10.5,3.3,16.5,3.3,8.6,0,15.6-2,20.8-5.8,5.2-3.9,7.8-9.4,7.8-16.2s-2.1-11.4-6.4-15.5c-4.2-4.1-10.9-7.5-20-10.3-4.8-1.5-8.5-3-11-4.7-2.3-1.6-3.5-3.5-3.5-5.7s1-4.4,3-6c2-1.5,4.9-2.3,8.6-2.3s6.8.9,8.9,2.8c2.1,1.8,3.1,4.4,3.1,7.7v.7h17.2v-.7c0-4.7-1.2-9-3.7-12.7-2.4-3.7-5.9-6.6-10.3-8.7Z" class="st0"/><rect height="55.9" width="16.7" y="163.2" x="608.1" class="st0"/><path d="M686.8,186.5c-.6-8.2-3.4-14.9-8.4-19.7-5-4.8-11.5-7.3-19.4-7.3s-10.5,1.3-14.6,3.7c-4.2,2.5-7.5,6.1-9.7,10.6-2.2,4.5-3.3,9.7-3.3,15.5v.7c0,9.2,2.5,16.6,7.6,22,5,5.4,11.8,8.1,20.2,8.1s15.2-2.8,20.2-8.2c5-5.4,7.5-12.7,7.5-21.6v-3.9ZM650.9,177.3c1.9-2.8,4.6-4.1,8.1-4.1s6.3,1.3,8.2,4.1c2,2.8,3,6.9,3,12s-1,10.5-3,13.3c-2,2.7-4.6,4-8.1,4s-6.3-1.3-8.2-4c-2-2.8-2.9-6.8-2.9-12.1s1-10.4,2.9-13.2Z" class="st0"/><path d="M582,164.8c-3.6-3.5-8-5.2-13.2-5.2s-12.8,2.8-17,8.2c-4.1,5.4-6.1,12.7-6.1,21.7s2.1,17.1,6.2,22.5c4.2,5.5,9.8,8.2,16.7,8.2s10.5-2.1,14.2-6.2l.6,5.2h15.1v-76.8h-16.7v22.4ZM572.6,206.6c-3.4,0-5.8-1.3-7.6-4-1.8-2.7-2.7-6.8-2.7-12,0-11.6,3.4-17.3,10.4-17.3s7.4,1.8,9.2,5.5v22.3c-1.8,3.7-4.9,5.5-9.3,5.5Z" class="st0"/></g></svg>
      <span style="font-size:13px;color:#525252;font-weight:500;">Watchdog</span>
      <div id="wallStatus" style="display:none;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;letter-spacing:0.03em;"></div>
    </div>
    <div class="status" style="display:flex;align-items:center;gap:12px;">
      <span class="data-points" id="dataPoints"></span>
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected</span>
      <button id="startBtn" onclick="startVuos()" style="display:none;margin-left:8px;padding:4px 12px;font-size:12px;background:#16a34a;color:#fff;border:1px solid #15803d;border-radius:6px;cursor:pointer;font-weight:600;">Start Vu OS</button>
      <button id="restartBtn" onclick="restartVuos()" style="display:none;margin-left:8px;padding:4px 12px;font-size:12px;background:#2563eb;color:#fff;border:1px solid #1d4ed8;border-radius:6px;cursor:pointer;font-weight:600;">Restart Vu OS</button>
      <button id="killBtn" onclick="killWatchdog()" style="display:none;margin-left:8px;padding:4px 12px;font-size:12px;background:#dc2626;color:#fff;border:1px solid #991b1b;border-radius:6px;cursor:pointer;font-weight:600;">Kill Watchdog</button>
    </div>
  </div>

  <div class="controls">
    <label>Broker:</label>
    <select id="brokerSelect" style="min-width:160px;" onchange="onBrokerSwitch()"></select>
    <span id="remoteControls"><label style="margin-left:8px;">Wall ID:</label>
    <input type="text" id="wallIdInput" value="5538" style="width: 120px;" placeholder="e.g. 5538" />
    <button id="connectBtn" onclick="toggleConnection()">Connect</button></span>
    <div id="leaseIndicator" class="lease-indicator" style="display:none;margin-left:8px;">
      <span id="leaseIcon">&#128275;</span>
      <span id="leaseText">No lease</span>
    </div>
    <label style="margin-left:12px;">History:</label>
    <select id="historyRange" onchange="updateChartRange()">
      <option value="0.5" selected>30 sec</option>
      <option value="30">30 min</option>
      <option value="60">1 hour</option>
      <option value="180">3 hours</option>
      <option value="0">All</option>
    </select>
  </div>

  <!-- Health Mode Banner -->
  <div id="healthBanner" class="health-banner"></div>

  <div id="dashboard" style="display:none;">
    <!-- Live Metrics -->
    <div class="grid">
      <div class="card">
        <div class="card-title">System</div>
        <div class="metric-row">
          <span class="metric-label">CPU</span>
          <span class="metric-value" id="cpuModel">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">CPU Usage</span>
          <span class="metric-value" id="cpuUsage">â€”</span>
        </div>
        <div class="bar-container"><div class="bar-fill" id="cpuBar" style="width:0%;background:#22c55e;"></div></div>
        <div class="metric-row" style="margin-top:12px;">
          <span class="metric-label">RAM</span>
          <span class="metric-value" id="ramUsage">â€”</span>
        </div>
        <div class="bar-container"><div class="bar-fill" id="ramBar" style="width:0%;background:#22c55e;"></div></div>
        <div class="metric-row" style="margin-top:12px;">
          <span class="metric-label">Uptime</span>
          <span class="metric-value" id="uptime">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:12px;">GPU</div>
        <div class="metric-row">
          <span class="metric-label">Model</span>
          <span class="metric-value" id="gpuName">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Usage</span>
          <span class="metric-value" id="gpuUsage">â€”</span>
        </div>
        <div class="bar-container"><div class="bar-fill" id="gpuBar" style="width:0%;background:#22c55e;"></div></div>
        <div class="metric-row" style="margin-top:12px;">
          <span class="metric-label">VRAM</span>
          <span class="metric-value" id="gpuMem">â€”</span>
        </div>
        <div class="bar-container"><div class="bar-fill" id="gpuMemBar" style="width:0%;background:#22c55e;"></div></div>
        <div class="metric-row" style="margin-top:12px;">
          <span class="metric-label">Temperature</span>
          <span class="metric-value" id="gpuTemp">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:12px;">Disk</div>
        <div class="metric-row">
          <span class="metric-label">Disk Usage</span>
          <span class="metric-value" id="diskPercent">â€”<span style="font-weight:400;color:#737373;">%</span></span>
        </div>
        <div class="bar-container"><div class="bar-fill" id="diskBar" style="width:0%;background:#22c55e;"></div></div>
        <div class="metric-row" style="margin-top:8px;">
          <span class="metric-label">Used / Total</span>
          <span class="metric-value" id="diskUsage">â€”</span>
        </div>
        <div class="metric-row" style="margin-top:8px;">
          <span class="metric-label">Disk I/O</span>
          <span class="metric-value" id="diskIO">â€”</span>
        </div>
      </div>

      <div class="card" id="networkConfigCard">
        <div class="card-title">Network</div>
        <div class="metric-row">
          <span class="metric-label">Internet</span>
          <span class="metric-value" id="netOnline">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Latency</span>
          <span class="metric-value" id="netLatency">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Local Server</span>
          <span class="metric-value" id="netLocal">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Connected Peers</span>
          <span class="metric-value" id="netPeers">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:12px;">System Health</div>
        <div class="metric-row">
          <span class="metric-label">Thermal Throttling</span>
          <span class="metric-value" id="sysThrottle">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Pending Updates</span>
          <span class="metric-value" id="sysPendingUpdates">0</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Event Log Errors (1h)</span>
          <span class="metric-value" id="sysEventCount">0</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Last Event</span>
          <span class="metric-value" id="sysEventTime" style="font-size:11px;">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Event Message</span>
          <span class="metric-value" id="sysEventMsg" style="font-size:10px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">â€”</span>
        </div>

        <div id="configSection" style="display:none;">
          <div style="border-top:1px solid #262626;margin:14px 0;"></div>
          <div class="card-title" style="margin-bottom:12px;">Wall Configuration</div>
          <div class="metric-row">
            <span class="metric-label">Wall IP</span>
            <span class="metric-value" id="cfgWallIp">â€”</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Processor Mode</span>
            <span class="metric-value" id="cfgProcessor">â€”</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Displays</span>
            <span class="metric-value" id="cfgDisplays">â€”</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Active Assets</span>
            <span class="metric-value" id="cfgAssets">â€”</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Ports</span>
            <span class="metric-value" id="cfgConnected">â€”</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">OSC Endpoint</span>
            <span class="metric-value" id="cfgCameras">â€”</span>
          </div>
          <div id="cfgDisplaysList" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Application</div>
        <div class="metric-row">
          <span class="metric-label">VUOS Process</span>
          <span class="metric-value" id="appVuos">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Responding</span>
          <span class="metric-value" id="appResponding">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Server Process</span>
          <span class="metric-value" id="appServer">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">VUOS Memory</span>
          <span class="metric-value" id="appMemory">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">VUOS GPU Memory</span>
          <span class="metric-value" id="appGpuMem">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Threads / Handles</span>
          <span class="metric-value" id="appThreads">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Priority</span>
          <span class="metric-value" id="appPriority">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Process Uptime</span>
          <span class="metric-value" id="appProcUptime">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Crashes Today</span>
          <span class="metric-value" id="appCrashes">0</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Server Version</span>
          <span class="metric-value" id="appVersion">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Wall ID</span>
          <span class="metric-value" id="wallId">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Last Update</span>
          <span class="metric-value" id="lastUpdate">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:12px;">Server Health</div>
        <div class="metric-row">
          <span class="metric-label">Status</span>
          <span class="metric-value" id="lockHealthy">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">PID</span>
          <span class="metric-value" id="lockPid">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Heartbeat Age</span>
          <span class="metric-value" id="lockHeartbeatAge">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Last Heartbeat</span>
          <span class="metric-value" id="lockLastHeartbeat">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Process Uptime</span>
          <span class="metric-value" id="lockUptime">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:12px;">Error Log</div>
        <div class="metric-row">
          <span class="metric-label">Recent Errors</span>
          <span class="metric-value" id="errCount">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Last Error Time</span>
          <span class="metric-value" id="errTime">â€”</span>
        </div>
        <div style="margin-top:10px;padding:10px;background:#1a1a1a;border-radius:6px;font-family:'SF Mono','Fira Code',monospace;font-size:11px;color:#ef4444;word-break:break-all;min-height:36px;" id="errMessage">â€”</div>
      </div>

      <div class="card" id="streamingCard">
        <div class="card-title">Screen Streaming</div>
        <div class="metric-row">
          <span class="metric-label">Status</span>
          <span class="metric-value" id="streamStatus">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Uptime</span>
          <span class="metric-value" id="streamUptime">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Port</span>
          <span class="metric-value" id="streamPort">8000</span>
        </div>
        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnStartStream" onclick="startStream()" style="flex:1;min-width:100px;background:#22c55e;color:#000;border:none;padding:10px 16px;border-radius:6px;font-weight:600;cursor:pointer;">Start Stream</button>
          <button id="btnStopStream" onclick="stopStream()" style="flex:1;min-width:100px;background:#ef4444;color:#fff;border:none;padding:10px 16px;border-radius:6px;font-weight:600;cursor:pointer;display:none;">Stop Stream</button>
          <a id="streamViewerLink" href="#" target="_blank" style="flex:1;min-width:100px;text-align:center;background:#3b82f6;color:#fff;border:none;padding:10px 16px;border-radius:6px;font-weight:600;text-decoration:none;display:none;">Open Viewer</a>
        </div>
        <div id="streamNotAvailable" style="margin-top:12px;padding:10px;background:#7f1d1d;border-radius:6px;font-size:11px;color:#fca5a5;display:none;">
          webrtc-streamer not installed.<br/>
          Run: <code style="background:#450a0a;padding:2px 4px;border-radius:3px;">bun scripts/download-webrtc-streamer.ts</code>
        </div>
      </div>

      <div class="card" id="remoteStreamingCard">
        <div class="card-title">Remote Streaming</div>
        <div style="font-size:11px;color:#a1a1aa;margin-bottom:12px;">
          Enable remote viewing without port forwarding via VDO.ninja
        </div>
        <div class="metric-row">
          <span class="metric-label">Status</span>
          <span class="metric-value" id="remoteStatus">disconnected</span>
        </div>
        <div class="metric-row" id="remoteViewersRow" style="display:none;">
          <span class="metric-label">Viewers</span>
          <span class="metric-value" id="remoteViewerCount">0</span>
        </div>
        <div id="remoteUrlRow" style="display:none;margin-top:12px;">
          <div style="font-size:11px;color:#a1a1aa;margin-bottom:6px;">Share this URL with remote viewers:</div>
          <div style="display:flex;gap:6px;">
            <input type="text" id="remoteViewerUrl" readonly onclick="this.select()" style="flex:1;background:#1a1a1a;border:1px solid #262626;border-radius:6px;padding:8px 10px;color:#fff;font-family:'SF Mono','Fira Code',monospace;font-size:11px;">
            <button onclick="copyRemoteUrl(this)" style="background:#3b82f6;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">Copy</button>
          </div>
        </div>
        <div id="remoteError" style="display:none;margin-top:12px;padding:10px;background:#7f1d1d;border-radius:6px;font-size:11px;color:#fca5a5;"></div>
        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnStartRemote" onclick="startRemoteStream()" style="flex:1;min-width:100px;background:#8b5cf6;color:#fff;border:none;padding:10px 16px;border-radius:6px;font-weight:600;cursor:pointer;">Enable Remote</button>
          <button id="btnStopRemote" onclick="stopRemoteStream()" style="flex:1;min-width:100px;background:#ef4444;color:#fff;border:none;padding:10px 16px;border-radius:6px;font-weight:600;cursor:pointer;display:none;">Disable Remote</button>
        </div>
        <div id="remoteRequiresLocal" style="margin-top:10px;font-size:11px;color:#a1a1aa;display:none;">
          Local streaming must be running first
        </div>
      </div>

      <div class="card" id="assetPreviewCard" style="display:none;">
        <div class="card-title">Live Asset</div>
        <div id="assetPreviewContainer" style="background:#0a0a0a;border-radius:6px;overflow:hidden;border:1px solid #262626;aspect-ratio:16/9;margin-bottom:12px;position:relative;">
          <img id="assetPreviewImg" style="width:100%;height:100%;display:block;object-fit:contain;" />
          <video id="assetPreviewVideo" style="width:100%;height:100%;display:none;object-fit:contain;" muted autoplay loop playsinline></video>
        </div>
        <div class="metric-row">
          <span class="metric-label">Title</span>
          <span class="metric-value" id="assetTitle" style="font-size:12px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Type</span>
          <span class="metric-value" id="assetType">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Provider</span>
          <span class="metric-value" id="assetProvider">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Loaded At</span>
          <span class="metric-value" id="assetTime">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="assetMeta"></span>
          <span class="metric-value" id="assetId" style="font-size:10px;color:#525252;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">â€”</span>
        </div>
      </div>

    </div>

    <!-- Time Series Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">CPU & RAM Usage</div>
          <span class="data-points" id="cpuRamPoints"></span>
        </div>
        <div class="chart-container"><canvas id="cpuRamChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">GPU Usage & Temperature</div>
          <span class="data-points" id="gpuPoints"></span>
        </div>
        <div class="chart-container"><canvas id="gpuChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">Network Latency</div>
          <span class="data-points" id="netPoints"></span>
        </div>
        <div class="chart-container"><canvas id="netChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">VRAM & RAM (GB)</div>
          <span class="data-points" id="memPoints"></span>
        </div>
        <div class="chart-container"><canvas id="memChart"></canvas></div>
      </div>
    </div>

    <!-- Asset Preview (inside the grid with other cards) -->

    <!-- Commands + Rate (same grid as charts) -->
    <div class="charts-grid">
      <div class="chart-card" style="margin-bottom:0;">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">Live Commands</div>
          <span style="text-transform:none;letter-spacing:0;font-variant-numeric:tabular-nums;font-size:12px;color:#a3a3a3;" id="cmdRate">0 cmd/s</span>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;font-variant-numeric:tabular-nums;">
          <span style="font-size:12px;color:#a3a3a3;background:#1a1a1a;padding:4px 10px;border-radius:4px;"><span style="font-weight:700;color:#fafafa;" id="cmdTotal">0</span> total</span>
          <span style="font-size:12px;color:#a3a3a3;background:#1a1a1a;padding:4px 10px;border-radius:4px;"><span style="font-weight:700;color:#3b82f6;" id="cmdUnique">0</span> unique</span>
          <span style="font-size:12px;color:#a3a3a3;background:#1a1a1a;padding:4px 10px;border-radius:4px;"><span style="font-weight:700;color:#f59e0b;" id="cmdPeak">0</span> peak/s</span>
        </div>
        <div class="log-container" id="cmdLogContainer" style="max-height:180px;"></div>
      </div>

      <div class="chart-card" style="margin-bottom:0;">
        <div class="card-title">Command Breakdown</div>
        <div id="cmdBreakdown" style="max-height:260px;overflow-y:auto;"></div>
      </div>

      <div class="chart-card" style="margin-bottom:0;">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">Command Rate</div>
          <span class="data-points" id="cmdRatePoints"></span>
        </div>
        <div class="chart-container"><canvas id="cmdRateChart"></canvas></div>
      </div>

      <div class="chart-card" style="margin-bottom:0;">
        <div class="card-title">Raw Telemetry Messages</div>
        <div class="log-container" id="logContainer" style="max-height:200px;"></div>
      </div>
    </div>

    <!-- Events Panel -->
    <div class="charts-grid">
      <div class="chart-card" style="margin-bottom:0;">
        <div class="chart-header">
          <div class="card-title" style="margin-bottom:0;">Events</div>
          <span class="data-points" id="eventCount">0 events</span>
        </div>
        <div class="log-container" id="eventLogContainer" style="max-height:240px;"></div>
      </div>
    </div>

    <!-- Data Throughput -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
      <div class="card">
        <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ðŸ“Š Data Throughput</span>
          <span style="text-transform:none;letter-spacing:0;font-variant-numeric:tabular-nums;font-size:12px;color:#a3a3a3;" id="tpDuration">0s</span>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:12px;">
          <div style="flex:1;text-align:center;padding:10px;background:#1a1a1a;border-radius:6px;">
            <div style="font-size:20px;font-weight:700;color:#fafafa;font-variant-numeric:tabular-nums;" id="tpTotal">0 B</div>
            <div style="font-size:11px;color:#525252;margin-top:2px;">Total Data</div>
          </div>
          <div style="flex:1;text-align:center;padding:10px;background:#1a1a1a;border-radius:6px;">
            <div style="font-size:20px;font-weight:700;color:#3b82f6;font-variant-numeric:tabular-nums;" id="tpMessages">0</div>
            <div style="font-size:11px;color:#525252;margin-top:2px;">Messages</div>
          </div>
          <div style="flex:1;text-align:center;padding:10px;background:#1a1a1a;border-radius:6px;">
            <div style="font-size:20px;font-weight:700;color:#22c55e;font-variant-numeric:tabular-nums;" id="tpAvgRate">0 B/s</div>
            <div style="font-size:11px;color:#525252;margin-top:2px;">Avg Rate</div>
          </div>
          <div style="flex:1;text-align:center;padding:10px;background:#1a1a1a;border-radius:6px;">
            <div style="font-size:20px;font-weight:700;color:#f59e0b;font-variant-numeric:tabular-nums;" id="tpPeakRate">0 B/s</div>
            <div style="font-size:11px;color:#525252;margin-top:2px;">Peak Rate</div>
          </div>
        </div>

        <div class="metric-row">
          <span class="metric-label">Avg Message Size</span>
          <span class="metric-value" id="tpAvgMsg">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:12px;">By Topic Type</div>
        <div id="tpBreakdown"></div>
      </div>

      <div class="card">
        <div class="card-title">ðŸ’° Cost Projection (1 Wall)</div>
        <p style="font-size:11px;color:#525252;margin-bottom:12px;">Extrapolated from session data</p>

        <div style="display:flex;gap:12px;margin-bottom:16px;">
          <div style="flex:1;text-align:center;padding:12px;background:#1a1a1a;border-radius:6px;">
            <div style="font-size:18px;font-weight:700;color:#fafafa;font-variant-numeric:tabular-nums;" id="tpMonthly">â€”</div>
            <div style="font-size:11px;color:#525252;margin-top:2px;">/ month</div>
          </div>
          <div style="flex:1;text-align:center;padding:12px;background:#1a1a1a;border-radius:6px;">
            <div style="font-size:18px;font-weight:700;color:#a3a3a3;font-variant-numeric:tabular-nums;" id="tpMsgsMonth">â€”</div>
            <div style="font-size:11px;color:#525252;margin-top:2px;">msgs / month</div>
          </div>
        </div>

        <div class="metric-row">
          <span class="metric-label">Hourly</span>
          <span class="metric-value" id="tpHourly">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Daily</span>
          <span class="metric-value" id="tpDaily">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Per Wall / Month</span>
          <span class="metric-value" id="tpPerWall">â€”</span>
        </div>

        <div style="border-top:1px solid #262626;margin:14px 0;"></div>
        <div class="card-title" style="margin-bottom:8px;">Fleet Estimates</div>
        <p style="font-size:11px;color:#525252;margin-bottom:10px;">Multiply per-wall by number of walls</p>
        <div class="metric-row">
          <span class="metric-label">10 Walls</span>
          <span class="metric-value" id="tpFleet10">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">50 Walls</span>
          <span class="metric-value" id="tpFleet50">â€”</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">100 Walls</span>
          <span class="metric-value" id="tpFleet100">â€”</span>
        </div>
      </div>
    </div>
  </div>

  <div id="emptyState" class="empty-state">
    <h2>ðŸ“¡</h2>
    <p>Enter a topic and click Connect to start monitoring</p>
  </div>

  <script>
    let client = null;
    let messageCount = 0;

    // Chart instances
    let cpuRamChart, gpuChart, netChart, memChart, cmdRateChart;

    // Command tracking
    let cmdTotal = 0;
    let cmdPeakRate = 0;
    const cmdCounts = {};        // address â†’ count
    let cmdSecondBucket = 0;     // commands in current second
    let cmdLastSecond = Math.floor(Date.now() / 1000);

    // â”€â”€ Data throughput tracking â”€â”€
    let totalBytes = 0;
    let totalMessages = 0;
    const topicBytes = { telemetry: 0, commands: 0, config: 0, health: 0, event: 0, ack: 0, other: 0 };
    const topicMsgs = { telemetry: 0, commands: 0, config: 0, health: 0, event: 0, ack: 0, other: 0 };
    let byteSecondBucket = 0;
    let byteLastSecond = Math.floor(Date.now() / 1000);
    let peakBytesPerSec = 0;
    let sessionStartTime = null;

    const CMD_COLORS = {
      // â”€â”€ Media Control (greens) â”€â”€
      '/VuOne/playAsset': '#22c55e',
      '/VuOne/selectAsset': '#16a34a',
      '/VuOne/playScene': '#4ade80',
      '/VuOne/setOverlayAsset': '#86efac',
      '/VuOne/setSplashImage': '#bbf7d0',
      '/VuOne/setScreensaver': '#a7f3d0',

      // â”€â”€ Playback (purples) â”€â”€
      '/VuOne/play': '#a855f7',
      '/VuOne/pause': '#9333ea',
      '/VuOne/playAll': '#c084fc',
      '/VuOne/pauseAll': '#7c3aed',
      '/VuOne/stopAllPlayback': '#6d28d9',
      '/VuOne/playbackPosition': '#d8b4fe',
      '/VuOne/requestPlaybackPosition': '#e9d5ff',
      '/VuOne/setAllPlaybackPos': '#ddd6fe',
      '/VuOne/setLoop': '#8b5cf6',
      '/VuOne/inPoint': '#c4b5fd',
      '/VuOne/outPoint': '#a78bfa',

      // â”€â”€ Audio (violet-pink) â”€â”€
      '/VuOne/masterVolume': '#d946ef',
      '/VuOne/volume': '#e879f9',
      '/VuOne/videoSpeed': '#f0abfc',

      // â”€â”€ Transform (blues) â”€â”€
      '/VuOne/position': '#3b82f6',
      '/VuOne/scale': '#2563eb',
      '/VuOne/rotation': '#60a5fa',
      '/VuOne/cameraRigPosition': '#93c5fd',
      '/VuOne/focalLength': '#1d4ed8',
      '/VuOne/panoRotation': '#bfdbfe',
      '/VuOne/verticalRotation': '#1e40af',

      // â”€â”€ Visual Attributes (ambers/oranges) â”€â”€
      '/VuOne/opacity': '#f59e0b',
      '/VuOne/exposure': '#d97706',
      '/VuOne/saturation': '#fbbf24',
      '/VuOne/contrast': '#f97316',
      '/VuOne/temperature': '#fb923c',
      '/VuOne/blur': '#fcd34d',
      '/VuOne/tint': '#fdba74',
      '/VuOne/depthExtrusion': '#ea580c',
      '/VuOne/timeOfDay': '#c2410c',
      '/VuOne/cornerRadius': '#fed7aa',
      '/VuOne/blacks': '#92400e',
      '/VuOne/whites': '#fef3c7',
      '/VuOne/shadows': '#b45309',
      '/VuOne/highlights': '#fde68a',
      '/VuOne/panoExposure': '#78350f',

      // â”€â”€ Crop & Flip (slate-blue) â”€â”€
      '/VuOne/cropTop': '#64748b',
      '/VuOne/cropBottom': '#475569',
      '/VuOne/cropLeft': '#94a3b8',
      '/VuOne/cropRight': '#cbd5e1',
      '/VuOne/flipVertical': '#334155',
      '/VuOne/flipHorizontal': '#1e293b',
      '/VuOne/blackIsTransparency': '#e2e8f0',
      '/VuOne/isLocked': '#f1f5f9',

      // â”€â”€ Display (teals) â”€â”€
      '/VuOne/targetDisplay': '#14b8a6',
      '/VuOne/setFloor': '#0d9488',
      '/VuOne/setCeiling': '#2dd4bf',
      '/VuOne/displaySources': '#5eead4',
      '/VuOne/displayURL': '#99f6e4',
      '/VuOne/updateAssetOrder': '#0f766e',

      // â”€â”€ Camera/PTZ (cyans) â”€â”€
      '/VuOne/connectToCamera': '#06b6d4',
      '/VuOne/disconnectFromCamera': '#0891b2',
      '/VuOne/setCameraProperty': '#22d3ee',
      '/VuOne/setCameraRecord': '#67e8f9',
      '/VuOne/updateCameraIPs': '#a5f3fc',
      '/VuOne/ptzValues': '#0e7490',

      // â”€â”€ Lighting/DMX (reds) â”€â”€
      '/VuOne/sendDMXCommand': '#ef4444',
      '/VuOne/setPixelMappingEnabled': '#dc2626',
      '/VuOne/ledBrightness': '#f87171',
      '/VuOne/toggleLedFade': '#fca5a5',

      // â”€â”€ Playlist (lime) â”€â”€
      '/VuOne/startPlaylist': '#84cc16',
      '/VuOne/stopPlaylist': '#65a30d',
      '/VuOne/playlistLoop': '#a3e635',
      '/VuOne/playlistDefaultDuration': '#bef264',

      // â”€â”€ Music (sky) â”€â”€
      '/VuOne/playMusic': '#0ea5e9',
      '/VuOne/pauseMusic': '#0284c7',
      '/VuOne/resumeMusic': '#38bdf8',
      '/VuOne/stopMusic': '#0369a1',
      '/VuOne/setMusicVolume': '#7dd3fc',
      '/VuOne/prevMusicTrack': '#bae6fd',
      '/VuOne/nextMusicTrack': '#e0f2fe',

      // â”€â”€ Cursor (rose) â”€â”€
      '/VuOne/cursor': '#f43f5e',
      '/VuOne/toggleCursor': '#fb7185',

      // â”€â”€ Web (indigo) â”€â”€
      '/VuOne/webKeyPress': '#6366f1',
      '/VuOne/webClick': '#818cf8',
      '/VuOne/reloadWebpage': '#a5b4fc',

      // â”€â”€ System/Config (pinks) â”€â”€
      '/VuOne/updateUISettings': '#ec4899',
      '/VuOne/resetWallSettings': '#db2777',
      '/VuOne/setTransition': '#f472b6',
      '/VuOne/setTimeoutMinutes': '#f9a8d4',
      '/VuOne/requestUpdate': '#be185d',
      '/VuOne/checkForUpdates': '#9d174d',
      '/VuOne/sendServerLogs': '#fbcfe8',
      '/VuOne/adminSetup': '#831843',
      '/VuOne/refreshNDI': '#fce7f3',
      '/VuOne/downloadDepthMap': '#701a75',
      '/VuOne/downloadMultipleAssets': '#86198f',
      '/VuOne/playerMode': '#a21caf',
      '/VuOne/trackingMode': '#c026d3',
      '/VuOne/sensors': '#d946ef',
      '/VuOne/OSC_sendToIP': '#e879f9',
      '/VuOne/userData': '#06b6d4',
      '/VuOne/connectioninfo': '#ec4899',
      '/VuOne/disconnect': '#be123c',
      '/VuOne/sleepMode': '#fda4af',

      // â”€â”€ Screenshare (emerald) â”€â”€
      '/VuOne/screenshareReady': '#10b981',
      '/VuOne/invalidScreensharePin': '#059669',
      '/VuOne/screensharePin': '#34d399',

      // â”€â”€ File browsing (stone) â”€â”€
      '/VuOne/requestLocalFolders': '#78716c',
      '/VuOne/requestLocalFiles': '#a8a29e',
      '/VuOne/requestSubfolders': '#d6d3d1',
      '/VuOne/requestFileThumbnail': '#57534e',

      // â”€â”€ NDI/Misc (zinc) â”€â”€
      '/VuOne/ndiInput': '#a1a1aa',
      '/VuOne/cursorEnabled': '#71717a',
      '/VuOne/cursorGrabEnabled': '#52525b',
    };

    // Chart.js defaults for dark theme
    Chart.defaults.color = '#737373';
    Chart.defaults.borderColor = '#262626';
    Chart.defaults.font.size = 11;
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, system-ui, sans-serif';

    const chartScaleDefaults = {
      grid: { color: '#1a1a1a' },
      ticks: { maxTicksLimit: 8 },
    };

    let durationMs = 30 * 1000; // default 30 sec window

    function getTimeAxis() {
      return {
        type: 'time',
        time: { tooltipFormat: 'HH:mm:ss', displayFormats: { minute: 'HH:mm', second: 'HH:mm:ss', hour: 'HH:mm' } },
        ...chartScaleDefaults,
        min: Date.now() - durationMs,
        max: Date.now(),
      };
    }

    function makeDataset(label, color, borderDash) {
      return {
        label,
        data: [],
        borderColor: color,
        backgroundColor: color + '18',
        borderWidth: 1.5,
        pointRadius: 0,
        pointHitRadius: 8,
        tension: 0.3,
        fill: true,
        borderDash: borderDash || [],
      };
    }

    let scrollInterval = null;

    function initCharts() {
      const commonOptions = (yLabel, suggestedMax) => ({
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top', labels: { boxWidth: 12, padding: 12 } },
          tooltip: { backgroundColor: '#262626', titleColor: '#e5e5e5', bodyColor: '#a3a3a3', borderColor: '#333', borderWidth: 1 },
        },
        scales: {
          x: getTimeAxis(),
          y: { ...chartScaleDefaults, beginAtZero: true, suggestedMax, title: { display: true, text: yLabel, color: '#525252' } },
        },
      });

      cpuRamChart = new Chart(document.getElementById('cpuRamChart'), {
        type: 'line',
        data: { datasets: [makeDataset('CPU %', '#3b82f6'), makeDataset('RAM %', '#a855f7')] },
        options: commonOptions('%', 100),
      });

      gpuChart = new Chart(document.getElementById('gpuChart'), {
        type: 'line',
        data: { datasets: [makeDataset('GPU %', '#22c55e'), makeDataset('Temp Â°C', '#f59e0b', [4, 2])] },
        options: {
          ...commonOptions('', 100),
          scales: {
            x: getTimeAxis(),
            y: { ...chartScaleDefaults, beginAtZero: true, suggestedMax: 100, position: 'left', title: { display: true, text: 'Usage %', color: '#525252' } },
            y1: { ...chartScaleDefaults, beginAtZero: true, suggestedMax: 90, position: 'right', title: { display: true, text: 'Â°C', color: '#525252' }, grid: { drawOnChartArea: false } },
          },
        },
      });
      gpuChart.data.datasets[1].yAxisID = 'y1';

      netChart = new Chart(document.getElementById('netChart'), {
        type: 'line',
        data: { datasets: [makeDataset('Latency', '#06b6d4')] },
        options: commonOptions('ms', 100),
      });

      memChart = new Chart(document.getElementById('memChart'), {
        type: 'line',
        data: { datasets: [makeDataset('RAM Used', '#a855f7'), makeDataset('VRAM Used', '#f43f5e')] },
        options: commonOptions('GB', 32),
      });

      cmdRateChart = new Chart(document.getElementById('cmdRateChart'), {
        type: 'line',
        data: { datasets: [makeDataset('cmd/s', '#ec4899')] },
        options: commonOptions('cmd/s', 60),
      });

      // Start realtime scroll via requestAnimationFrame for smooth 60fps
      scrollCharts();
    }

    function scrollCharts() {
      const now = Date.now();
      [cpuRamChart, gpuChart, netChart, memChart, cmdRateChart].forEach(chart => {
        chart.options.scales.x.min = now - durationMs;
        chart.options.scales.x.max = now;
        chart.update('none');
      });
      requestAnimationFrame(scrollCharts);
    }

    function pushHistory(d) {
      const s = d.system || {};
      const n = d.network || {};
      const now = Date.now();

      // Push into datasets
      cpuRamChart.data.datasets[0].data.push({ x: now, y: s.cpuUsage });
      cpuRamChart.data.datasets[1].data.push({ x: now, y: s.ramPercent });

      gpuChart.data.datasets[0].data.push({ x: now, y: s.gpuUsage });
      gpuChart.data.datasets[1].data.push({ x: now, y: s.gpuTemp });

      netChart.data.datasets[0].data.push({ x: now, y: n.latencyMs });

      memChart.data.datasets[0].data.push({ x: now, y: s.ramUsedMB ? +(s.ramUsedMB / 1024).toFixed(2) : null });
      memChart.data.datasets[1].data.push({ x: now, y: s.gpuMemUsedMB ? +(s.gpuMemUsedMB / 1024).toFixed(2) : null });

      // Trim old data (older than 3 hours)
      const cutoff = now - 3 * 60 * 60 * 1000;
      [cpuRamChart, gpuChart, netChart, memChart, cmdRateChart].forEach(chart => {
        chart.data.datasets.forEach(ds => {
          while (ds.data.length > 0 && ds.data[0].x < cutoff) ds.data.shift();
        });
      });

      // Update counts
      const pts = cpuRamChart.data.datasets[0].data.length;
      document.getElementById('dataPoints').textContent = pts + ' samples';
      document.getElementById('cpuRamPoints').textContent = pts + ' pts';
      document.getElementById('gpuPoints').textContent = pts + ' pts';
      document.getElementById('netPoints').textContent = pts + ' pts';
      document.getElementById('memPoints').textContent = pts + ' pts';
    }

    function updateChartRange() {
      const mins = parseFloat(document.getElementById('historyRange').value);
      durationMs = mins === 0 ? 3 * 60 * 60 * 1000 : mins * 60 * 1000;
      scrollCharts();
    }

    // ---- Connection ----

    function toggleConnection() {
      if (client && client.connected) {
        client.end();
        return;
      }
      connect();
    }

    function getSelectedBroker() {
      var sel = document.getElementById('brokerSelect');
      var idx = sel.selectedIndex;
      if (idx < 0 || !window._mqttBrokers) return null;
      return window._mqttBrokers[idx] || null;
    }

    function populateBrokerSelect(activeBrokerId) {
      var sel = document.getElementById('brokerSelect');
      sel.innerHTML = '';
      var brokers = window._mqttBrokers || [];
      brokers.forEach(function(b) {
        var opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.label;
        if (b.id === activeBrokerId) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function onBrokerSwitch() {
      var sel = document.getElementById('brokerSelect');
      var brokerId = sel.value;
      if (!brokerId || !isLocal) return;
      sel.disabled = true;
      fetch('/api/switch-broker', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brokerId: brokerId })
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          sel.disabled = false;
          if (data.ok) {
            addLog('Switched broker to ' + sel.options[sel.selectedIndex].textContent);
          } else {
            addLog('Broker switch failed: ' + (data.error || 'unknown'));
          }
        })
        .catch(function(err) {
          sel.disabled = false;
          addLog('Broker switch error: ' + err.message);
        });
    }

    function connect() {
      const wallId = document.getElementById('wallIdInput').value.trim();
      if (!wallId) return;

      setStatus('connecting');

      var broker = getSelectedBroker();
      var brokerUrl = (broker && broker.url) || 'wss://c9b6cc55.ala.us-east-1.emqxsl.com:8084/mqtt';
      var brokerUser = (broker && broker.username) || '';
      var brokerPass = (broker && broker.password) || '';
      var mqttOpts = {
        clientId: 'telemetry-monitor-' + Math.random().toString(36).slice(2, 8),
        reconnectPeriod: 5000,
      };
      if (brokerUser) { mqttOpts.username = brokerUser; mqttOpts.password = brokerPass; }
      client = mqtt.connect(brokerUrl, mqttOpts);

      const wildcardTopic = 'watchdog/' + wallId + '/#';

      client.on('connect', () => {
        setStatus('connected');
        client.subscribe(wildcardTopic);
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        if (!cpuRamChart) initCharts();
        addLog('Subscribed to ' + wildcardTopic + ' via ' + (broker && broker.label || 'default'));
      });

      client.on('message', (t, payload) => {
        // â”€â”€ Track bytes for throughput â”€â”€
        if (!sessionStartTime) sessionStartTime = Date.now();
        const payloadBytes = payload.byteLength || payload.length || 0;
        const topicOverhead = t.length; // topic string bytes
        const msgBytes = payloadBytes + topicOverhead + 5; // +5 for MQTT header overhead
        totalBytes += msgBytes;
        totalMessages++;

        // Classify by topic type
        let topicType = 'other';
        if (t.endsWith('/commands')) topicType = 'commands';
        else if (t.endsWith('/config')) topicType = 'config';
        else if (t.endsWith('/status') || t.endsWith('/health')) topicType = 'health';
        else if (t.endsWith('/telemetry')) topicType = 'telemetry';
        else if (t.endsWith('/event')) topicType = 'event';
        else if (t.includes('/ack/')) topicType = 'ack';
        topicBytes[topicType] += msgBytes;
        topicMsgs[topicType] += 1;

        // Per-second byte rate
        const nowByteSec = Math.floor(Date.now() / 1000);
        if (nowByteSec === byteLastSecond) {
          byteSecondBucket += msgBytes;
        } else {
          if (byteSecondBucket > peakBytesPerSec) peakBytesPerSec = byteSecondBucket;
          byteSecondBucket = msgBytes;
          byteLastSecond = nowByteSec;
        }

        updateThroughputUI();

        try {
          const data = JSON.parse(payload.toString());
          if (t.endsWith('/commands')) {
            handleCommand(data);
          } else if (t.endsWith('/config')) {
            handleConfig(data);
          } else if (t.endsWith('/status')) {
            handleHealth(data);
          } else if (t.endsWith('/health')) {
            handleHealthV2(data);
          } else if (t.endsWith('/event')) {
            appendEvent(data);
          } else if (t.includes('/ack/')) {
            handleAck(data);
          } else if (t.endsWith('/telemetry')) {
            messageCount++;
            updateDashboard(data);
            pushHistory(data);
            addLog('Telemetry #' + messageCount + ' from ' + (data.wallId || 'unknown'));
          } else {
            addLog('Unknown topic ' + t + ': ' + payload.toString().slice(0, 120));
          }
        } catch (e) {
          addLog('Non-JSON on ' + t + ': ' + payload.toString().slice(0, 100));
        }
      });

      client.on('error', (err) => {
        setStatus('error');
        addLog('Error: ' + err.message);
      });

      client.on('close', () => {
        setStatus('disconnected');
      });
    }

    function handleCommand(data) {
      const addr = data.address || 'unknown';
      const args = data.args || [];

      // Asset preview â€” playAsset / selectAsset may carry asset JSON with downloadLink
      if (addr === '/VuOne/playAsset' || addr === '/VuOne/selectAsset') {
        handleAssetPreview(addr, args);
      }

      // Count
      cmdTotal++;
      cmdCounts[addr] = (cmdCounts[addr] || 0) + 1;

      // Rate tracking â€” bucket per second
      const nowSec = Math.floor(Date.now() / 1000);
      if (nowSec === cmdLastSecond) {
        cmdSecondBucket++;
      } else {
        // Flush previous second to chart
        if (cmdRateChart) {
          cmdRateChart.data.datasets[0].data.push({ x: cmdLastSecond * 1000, y: cmdSecondBucket });
        }
        if (cmdSecondBucket > cmdPeakRate) {
          cmdPeakRate = cmdSecondBucket;
          document.getElementById('cmdPeak').textContent = cmdPeakRate;
        }
        cmdSecondBucket = 1;
        cmdLastSecond = nowSec;
      }

      // Update UI counters
      document.getElementById('cmdTotal').textContent = cmdTotal;
      document.getElementById('cmdUnique').textContent = Object.keys(cmdCounts).length;
      document.getElementById('cmdRate').textContent = cmdSecondBucket + ' cmd/s';
      document.getElementById('cmdRatePoints').textContent = (cmdRateChart ? cmdRateChart.data.datasets[0].data.length : 0) + ' pts';

      // Add to command log (throttle position to avoid flood)
      const argsStr = args.map(a => typeof a === 'object' ? JSON.stringify(a).slice(0, 80) : a).join(', ');
      const shortAddr = addr.replace('/VuOne/', '');
      const color = CMD_COLORS[addr] || '#737373';

      // Throttle position logs (only show every 10th)
      if (addr === '/VuOne/position' && cmdCounts[addr] % 10 !== 0) return;

      const container = document.getElementById('cmdLogContainer');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = '<span class="log-time">' + new Date().toLocaleTimeString() + '</span> ' +
        '<span style="color:' + color + ';font-weight:600;">' + shortAddr + '</span> ' +
        '<span style="color:#a3a3a3;">[' + argsStr + ']</span>';
      container.insertBefore(entry, container.firstChild);
      if (container.children.length > 80) container.removeChild(container.lastChild);

      // Update breakdown
      updateCmdBreakdown();
    }

    function updateCmdBreakdown() {
      const container = document.getElementById('cmdBreakdown');
      const sorted = Object.entries(cmdCounts).sort((a, b) => b[1] - a[1]);
      let html = '';
      for (const [addr, count] of sorted) {
        const shortAddr = addr.replace('/VuOne/', '');
        const color = CMD_COLORS[addr] || '#737373';
        const pct = cmdTotal > 0 ? (count / cmdTotal * 100).toFixed(1) : 0;
        html += '<div class="metric-row">' +
          '<span class="metric-label"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';margin-right:6px;"></span>' + shortAddr + '</span>' +
          '<span class="metric-value">' + count.toLocaleString() + ' <span style="color:#525252;font-weight:400;">(' + pct + '%)</span></span>' +
          '</div>' +
          '<div class="bar-container"><div class="bar-fill" style="width:' + pct + '%;background:' + color + ';"></div></div>';
      }
      container.innerHTML = html;
    }

    // â”€â”€ Throughput helpers â”€â”€

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(i > 0 ? 2 : 0) + ' ' + units[i];
    }

    function formatDuration(ms) {
      const s = Math.floor(ms / 1000);
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s / 60) + 'm ' + (s % 60) + 's';
      const h = Math.floor(s / 3600);
      return h + 'h ' + Math.floor((s % 3600) / 60) + 'm';
    }

    function updateThroughputUI() {
      const el = (id) => document.getElementById(id);
      if (!el('tpTotal')) return;

      const elapsed = sessionStartTime ? (Date.now() - sessionStartTime) : 0;
      const elapsedSec = elapsed / 1000 || 1;

      // Summary stats
      el('tpTotal').textContent = formatBytes(totalBytes);
      el('tpMessages').textContent = totalMessages.toLocaleString();
      el('tpAvgRate').textContent = formatBytes(totalBytes / elapsedSec) + '/s';
      el('tpPeakRate').textContent = formatBytes(peakBytesPerSec) + '/s';
      el('tpDuration').textContent = formatDuration(elapsed);
      el('tpAvgMsg').textContent = totalMessages > 0 ? formatBytes(totalBytes / totalMessages) : 'â€”';

      // Per-topic breakdown
      const types = ['commands', 'telemetry', 'config', 'health', 'event', 'ack', 'other'];
      const colors = { commands: '#ef4444', telemetry: '#3b82f6', config: '#f59e0b', health: '#22c55e', event: '#a855f7', ack: '#06b6d4', other: '#737373' };
      let html = '';
      for (const tp of types) {
        if (topicMsgs[tp] === 0) continue;
        const pct = totalBytes > 0 ? (topicBytes[tp] / totalBytes * 100).toFixed(1) : 0;
        html += '<div class="metric-row">' +
          '<span class="metric-label"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + colors[tp] + ';margin-right:6px;"></span>' + tp + '</span>' +
          '<span class="metric-value">' + formatBytes(topicBytes[tp]) + ' <span style="color:#525252;font-weight:400;">(' + topicMsgs[tp].toLocaleString() + ' msgs, ' + pct + '%)</span></span></div>' +
          '<div class="bar-container"><div class="bar-fill" style="width:' + pct + '%;background:' + colors[tp] + ';"></div></div>';
      }
      el('tpBreakdown').innerHTML = html;

      // Cost projections
      const bytesPerHour = totalBytes / elapsedSec * 3600;
      const bytesPerDay = bytesPerHour * 24;
      const bytesPerMonth = bytesPerDay * 30;
      const msgsPerHour = totalMessages / elapsedSec * 3600;
      const msgsPerMonth = msgsPerHour * 24 * 30;

      el('tpHourly').textContent = formatBytes(bytesPerHour);
      el('tpDaily').textContent = formatBytes(bytesPerDay);
      el('tpMonthly').textContent = formatBytes(bytesPerMonth);
      el('tpMsgsMonth').textContent = (msgsPerMonth / 1e6).toFixed(2) + 'M msgs';

      // Per-wall monthly (this is 1 wall, so same as above)
      el('tpPerWall').textContent = formatBytes(bytesPerMonth) + ' / wall';

      // Fleet estimates
      el('tpFleet10').textContent = formatBytes(bytesPerMonth * 10) + ' / mo';
      el('tpFleet50').textContent = formatBytes(bytesPerMonth * 50) + ' / mo';
      el('tpFleet100').textContent = formatBytes(bytesPerMonth * 100) + ' / mo';
    }

    // ---- Asset Preview ----

    function handleAssetPreview(addr, args) {
      // playAsset args: [displayIndex, bool, jsonString] or [displayIndex, bool, object]
      // selectAsset args: [assetId] or [jsonString]
      let assetData = null;

      for (const arg of args) {
        if (typeof arg === 'object' && arg !== null && (arg.downloadLink || arg.id)) {
          assetData = arg;
          break;
        }
        if (typeof arg === 'string' && arg.startsWith('{')) {
          try {
            assetData = JSON.parse(arg);
            break;
          } catch (e) {
            // Truncated JSON (>500 chars from watchdog) â€” extract fields with regex
            assetData = {};
            const idMatch = arg.match(/"id"\s*:\s*"([^"]+)"/);
            const titleMatch = arg.match(/"title"\s*:\s*"([^"]+)"/);
            const typeMatch = arg.match(/"type"\s*:\s*"([^"]+)"/);
            const providerMatch = arg.match(/"provider"\s*:\s*"([^"]+)"/);
            const filenameMatch = arg.match(/"filenameDownload"\s*:\s*"([^"]+)"/);
            const linkMatch = arg.match(/"downloadLink"\s*:\s*"([^"]*?)(?:"|$)/);
            if (idMatch) assetData.id = idMatch[1];
            if (titleMatch) assetData.title = titleMatch[1];
            if (typeMatch) assetData.type = typeMatch[1];
            if (providerMatch) assetData.provider = providerMatch[1];
            if (filenameMatch) assetData.filenameDownload = filenameMatch[1];
            if (linkMatch) assetData.downloadLink = linkMatch[1];
            if (Object.keys(assetData).length === 0) assetData = null;
            break;
          }
        }
      }

      if (!assetData) return;

      const card = document.getElementById('assetPreviewCard');
      card.style.display = '';

      // Pick the best preview URL based on asset type
      const type = (assetData.type || assetData.originalType || '').toLowerCase();
      const isVideo = type.startsWith('video/');
      const isAudio = type.startsWith('audio/');

      // For images: use downloadLink or src directly
      // For video/audio: use thumbnail (can't render mp4/audio in <img>)
      let previewUrl = '';
      if (isVideo || isAudio) {
        previewUrl = assetData.thumbnailLg || assetData.thumbnailMd || assetData.thumbnailSm
          || assetData.thumbAspectLg || assetData.thumbAspectMd || assetData.thumbAspectSm || '';
      }
      if (!previewUrl) {
        previewUrl = assetData.downloadLink || assetData.src || assetData.originalSrc
          || assetData.thumbnailLg || assetData.thumbnailMd || '';
      }

      const img = document.getElementById('assetPreviewImg');
      const video = document.getElementById('assetPreviewVideo');
      const videoSrc = assetData.downloadLink || assetData.src || '';

      if (isVideo && videoSrc && !videoSrc.endsWith('...')) {
        // Play video muted
        img.style.display = 'none';
        video.src = videoSrc;
        video.style.display = 'block';
        video.onerror = () => {
          video.style.display = 'none';
          // Fallback to thumbnail
          if (previewUrl) { img.src = previewUrl; img.style.display = ''; }
          addLog('Video failed to load, showing thumbnail');
        };
      } else if (previewUrl && !previewUrl.endsWith('...')) {
        // Show image
        video.style.display = 'none';
        video.src = '';
        img.src = previewUrl;
        img.alt = assetData.title || 'Asset preview';
        img.style.display = '';
        img.onerror = () => {
          img.style.display = 'none';
          addLog('Asset preview failed to load');
        };
      } else {
        img.style.display = 'none';
        video.style.display = 'none';
        video.src = '';
      }

      // Metadata
      const title = assetData.title || assetData.filenameDownload || 'Unknown';
      const filename = assetData.filenameDownload || '';
      const ext = filename.split('.').pop() || '?';
      const provider = assetData.provider || 'â€”';
      const id = assetData.id || 'â€”';

      setText('assetTitle', title);
      document.getElementById('assetTitle').title = filename;
      const typeLabel = type || ext.toUpperCase();
      const typeEl = document.getElementById('assetType');
      typeEl.textContent = typeLabel;
      typeEl.className = 'metric-value';
      if (isVideo) { typeEl.style.color = '#3b82f6'; }
      else if (isAudio) { typeEl.style.color = '#a855f7'; }
      else { typeEl.style.color = '#22c55e'; }
      setText('assetProvider', provider);
      setText('assetId', id);
      setText('assetTime', new Date().toLocaleTimeString());
      document.getElementById('assetMeta').textContent = addr.replace('/VuOne/', '');

      addLog('Asset loaded: ' + title + ' (' + ext + ')');
    }

    // ---- Config & Health handlers ----

    let lastConfigJson = '';

    function handleConfig(data) {
      // Stash MQTT broker configs
      if (data.mqttBroker) {
        window._mqttBrokers = data.mqttBroker.brokers || [];
        populateBrokerSelect(data.mqttBroker.activeBrokerId);
      }

      // Dedupe â€” config is retained + published every 60s
      const json = JSON.stringify(data);
      const changed = json !== lastConfigJson;
      lastConfigJson = json;

      document.getElementById('configSection').style.display = '';
      if (changed) addLog('Config received');

      // Exact paths from watchdog payload: { appConfig: {...}, systemConfig: {...} }
      const appCfg = data.appConfig || {};
      const sysCfg = data.systemConfig || {};
      const uiSettings = sysCfg.uiSettings || {};

      // Wall IP (systemConfig.wallIP)
      setText('cfgWallIp', sysCfg.wallIP || 'â€”');

      // Processor mode (systemConfig.processorMode)
      setText('cfgProcessor', sysCfg.processorMode || 'â€”');

      // Displays (systemConfig.displays[])
      const displays = sysCfg.displays || [];
      setText('cfgDisplays', displays.length + ' display' + (displays.length !== 1 ? 's' : ''));

      // Active assets â€” each display has its own displayedAssets[]
      let totalAssets = 0;
      let allAssets = [];
      displays.forEach(disp => {
        const assets = disp.displayedAssets || [];
        totalAssets += assets.length;
        assets.forEach(a => allAssets.push({ ...a, displayName: disp.nickname || disp.hardwareName }));
      });
      setText('cfgAssets', totalAssets > 0 ? totalAssets + ' active' : 'None');

      // Show first asset with a downloadLink in the preview card
      const previewAsset = allAssets.find(a => a.downloadLink);
      if (previewAsset) {
        handleAssetPreview('config', [previewAsset]);
      }

      // Connected users â€” comes from telemetry.network.connectedPeers, not config
      // Config has appConfig.httpPort which is used for the connected-users endpoint
      const ports = appCfg.websocketPort ? 'WS:' + appCfg.websocketPort + ' HTTP:' + appCfg.httpPort : 'â€”';
      setText('cfgConnected', ports);

      // OSC endpoint
      setText('cfgCameras', sysCfg.oscIp || 'None');

      // Display details with per-display assets
      const container = document.getElementById('cfgDisplaysList');
      if (displays.length > 0) {
        const TYPE_COLORS = {
          'image/png': '#22c55e', 'image/jpeg': '#22c55e', 'image/webp': '#22c55e', 'image/gif': '#22c55e',
          'video/mp4': '#3b82f6', 'video/webm': '#3b82f6',
          'audio/mpeg': '#a855f7', 'audio/wav': '#a855f7',
          'application/pdf': '#f59e0b',
        };
        let html = '';
        displays.forEach((disp, i) => {
          const name = disp.nickname || disp.hardwareName || ('Display ' + (i + 1));
          const res = disp.renderWidth && disp.renderHeight ? disp.renderWidth + 'Ã—' + disp.renderHeight : '';
          const mode = disp.displayMode || '';
          const active = disp.isActivated;
          const fullscreen = disp.isFullscreen;

          html += '<div style="margin-top:' + (i > 0 ? '8' : '0') + 'px;padding:8px 10px;background:#1a1a1a;border-radius:6px;border-left:3px solid ' + (active ? '#22c55e' : '#525252') + ';">';
          html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
          html += '<span style="color:#e5e5e5;font-size:12px;font-weight:600;">' + name + '</span>';
          html += '<span style="font-size:10px;color:#525252;">' + res + (fullscreen ? ' FS' : '') + '</span>';
          html += '</div>';
          if (mode) {
            html += '<div style="font-size:10px;color:#737373;margin-bottom:4px;">Mode: ' + mode + '</div>';
          }

          const assets = disp.displayedAssets || [];
          if (assets.length > 0) {
            assets.forEach(asset => {
              const title = asset.title || asset.filenameDownload || asset.id || 'Unknown';
              const type = asset.type || '?';
              const typeShort = type.split('/').pop();
              const color = TYPE_COLORS[type] || '#737373';
              html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px;">' +
                '<span style="color:#a3a3a3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;" title="' + (asset.filenameDownload || '') + '">' + title + '</span>' +
                '<span style="color:' + color + ';font-weight:600;font-size:10px;">' + typeShort + '</span>' +
                '</div>';
            });
          } else {
            html += '<div style="font-size:11px;color:#525252;font-style:italic;">No assets</div>';
          }
          html += '</div>';
        });
        container.innerHTML = html;
      } else {
        container.innerHTML = '';
      }
    }

    function handleHealth(data) {
      const badge = document.getElementById('wallStatus');
      badge.style.display = 'inline-block';

      if (data.status === 'online') {
        badge.textContent = 'â— WALL ONLINE';
        badge.style.background = '#052e16';
        badge.style.color = '#22c55e';
        badge.style.border = '1px solid #166534';
      } else {
        badge.textContent = 'â— WALL OFFLINE';
        badge.style.background = '#450a0a';
        badge.style.color = '#ef4444';
        badge.style.border = '1px solid #991b1b';
      }
      addLog('Health: ' + data.status + ' (wall ' + (data.wallId || '?') + ')');
    }

    function setStatus(state) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const btn = document.getElementById('connectBtn');

      dot.className = 'status-dot';
      btn.className = '';

      if (state === 'connected') {
        dot.classList.add('connected');
        text.textContent = 'Connected';
        btn.textContent = 'Disconnect';
        btn.classList.add('active');
      } else if (state === 'connecting') {
        text.textContent = 'Connecting...';
        btn.textContent = 'Connecting...';
      } else {
        text.textContent = state === 'error' ? 'Error' : 'Disconnected';
        btn.textContent = 'Connect';
      }
    }

    function updateDashboard(d) {
      const s = d.system || {};
      const n = d.network || {};
      const a = d.app || {};

      setText('cpuModel', shortenCpu(s.cpuModel));
      setText('cpuUsage', s.cpuUsage + '% (' + s.cpuCores + ' cores)');
      setBar('cpuBar', s.cpuUsage);
      setText('ramUsage', formatMB(s.ramUsedMB) + ' / ' + formatMB(s.ramTotalMB) + ' (' + s.ramPercent + '%)');
      setBar('ramBar', s.ramPercent);
      setText('uptime', formatUptime(s.uptime));

      setText('gpuName', shortenGpu(s.gpuName));
      setText('gpuUsage', s.gpuUsage + '%');
      setBar('gpuBar', s.gpuUsage);
      setText('gpuMem', formatMB(s.gpuMemUsedMB) + ' / ' + formatMB(s.gpuMemTotalMB));
      const gpuMemPct = s.gpuMemTotalMB ? Math.round(s.gpuMemUsedMB / s.gpuMemTotalMB * 100) : 0;
      setBar('gpuMemBar', gpuMemPct);
      const tempEl = document.getElementById('gpuTemp');
      tempEl.textContent = s.gpuTemp + 'Â°C';
      tempEl.className = 'metric-value' + (s.gpuTemp > 80 ? ' danger' : s.gpuTemp > 65 ? ' warn' : ' good');

      setText('diskPercent', s.diskPercent);
      setBar('diskBar', s.diskPercent);
      setText('diskUsage', formatGB(s.diskUsedMB) + ' / ' + formatGB(s.diskTotalMB));
      setText('diskIO', 'R: ' + (s.diskReadMBps || 0) + ' MB/s  W: ' + (s.diskWriteMBps || 0) + ' MB/s');

      // System Health
      var throttleEl = document.getElementById('sysThrottle');
      throttleEl.textContent = s.thermalThrottling ? 'YES' : 'No';
      throttleEl.style.color = s.thermalThrottling ? '#ef4444' : '#22c55e';
      var updEl = document.getElementById('sysPendingUpdates');
      updEl.textContent = s.pendingUpdates || 0;
      updEl.style.color = s.pendingUpdates > 0 ? '#f59e0b' : '#a3a3a3';
      var evtEl = document.getElementById('sysEventCount');
      evtEl.textContent = (s.eventLog && s.eventLog.count) || 0;
      evtEl.style.color = s.eventLog && s.eventLog.count > 0 ? '#ef4444' : '#a3a3a3';
      setText('sysEventTime', s.eventLog && s.eventLog.lastTime ? s.eventLog.lastTime : 'â€”');
      setText('sysEventMsg', s.eventLog && s.eventLog.lastMessage ? s.eventLog.lastMessage : 'â€”');

      setOnline('netOnline', n.internetOnline);
      setText('netLatency', n.latencyMs + ' ms');
      setOnline('netLocal', n.localServerReachable);
      setText('netPeers', n.connectedPeers);

      setOnline('appVuos', a.vuosProcessRunning);
      setOnline('appServer', a.serverProcessRunning);
      setText('appMemory', a.vuosMemoryMB != null ? formatMB(a.vuosMemoryMB) : 'â€”');

      // Extended VUOS process info
      var vp = a.vuosProcess;
      if (vp && a.vuosProcessRunning) {
        var respEl = document.getElementById('appResponding');
        respEl.textContent = vp.responding ? 'Yes' : 'FROZEN';
        respEl.className = 'metric-value ' + (vp.responding ? 'good' : 'danger');
        setText('appGpuMem', vp.gpuMemoryMB != null ? vp.gpuMemoryMB + ' MB' : 'â€”');
        setText('appThreads', vp.threads + ' / ' + vp.handles);
        var prioEl = document.getElementById('appPriority');
        prioEl.textContent = vp.priority;
        prioEl.className = 'metric-value' + (vp.priority === 'Normal' ? ' warn' : ' good');
        if (vp.startTime) {
          var procAge = Math.floor((Date.now() - new Date(vp.startTime).getTime()) / 1000);
          setText('appProcUptime', formatUptime(procAge));
        }
      } else {
        setText('appResponding', 'â€”');
        setText('appGpuMem', 'â€”');
        setText('appThreads', 'â€”');
        setText('appPriority', 'â€”');
        setText('appProcUptime', 'â€”');
      }

      var crashEl = document.getElementById('appCrashes');
      crashEl.textContent = a.crashCountToday || 0;
      crashEl.style.color = a.crashCountToday > 0 ? '#ef4444' : '#a3a3a3';
      if (isLocal) {
        document.getElementById('startBtn').style.display = a.vuosProcessRunning ? 'none' : '';
        document.getElementById('restartBtn').style.display = a.vuosProcessRunning ? '' : 'none';
      }
      setText('appVersion', a.serverVersion || 'â€”');
      setText('wallId', d.wallId || 'â€”');
      setText('lastUpdate', new Date(d.timestamp).toLocaleTimeString());

      // Server Health
      const lock = a.serverLock || {};
      if (lock.healthy !== undefined) {
        setOnline('lockHealthy', lock.healthy);
        setText('lockPid', lock.pid || 'â€”');
        const hbAge = lock.heartbeatAgeMs;
        const hbEl = document.getElementById('lockHeartbeatAge');
        hbEl.textContent = hbAge != null ? hbAge + ' ms' : 'â€”';
        hbEl.className = 'metric-value' + (hbAge > 5000 ? ' danger' : hbAge > 2000 ? ' warn' : ' good');
        setText('lockLastHeartbeat', lock.lastHeartbeat ? new Date(lock.lastHeartbeat).toLocaleTimeString() : 'â€”');
        if (lock.startTime) {
          const procUptime = Math.floor((d.timestamp - lock.startTime) / 1000);
          setText('lockUptime', formatUptime(procUptime));
        }
      }

      // Error Log
      const logs = a.logs || {};
      if (logs.recentErrorCount !== undefined) {
        const errEl = document.getElementById('errCount');
        errEl.textContent = logs.recentErrorCount;
        errEl.className = 'metric-value' + (logs.recentErrorCount > 5 ? ' danger' : logs.recentErrorCount > 0 ? ' warn' : ' good');
        setText('errTime', logs.lastErrorTime || 'â€”');
        document.getElementById('errMessage').textContent = logs.lastError || 'No errors';
        if (!logs.lastError || logs.recentErrorCount === 0) {
          document.getElementById('errMessage').style.color = '#22c55e';
        } else {
          document.getElementById('errMessage').style.color = '#ef4444';
        }
      }

    }

    function setBar(id, pct) {
      const el = document.getElementById(id);
      el.style.width = pct + '%';
      el.style.background = pct > 85 ? '#ef4444' : pct > 65 ? '#f59e0b' : '#22c55e';
    }

    function setText(id, val) { document.getElementById(id).textContent = val; }

    function setOnline(id, val) {
      const el = document.getElementById(id);
      el.textContent = val ? 'Online' : 'Offline';
      el.className = 'metric-value ' + (val ? 'good' : 'danger');
    }

    function formatMB(mb) { return mb >= 1024 ? (mb / 1024).toFixed(1) + ' GB' : mb + ' MB'; }
    function formatGB(mb) { return (mb / 1024).toFixed(0) + ' GB'; }

    function formatUptime(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return (d ? d + 'd ' : '') + h + 'h ' + m + 'm';
    }

    function shortenCpu(name) {
      if (!name) return 'â€”';
      return name.replace('Intel(R) Core(TM) ', '').replace('AMD ', '');
    }

    function shortenGpu(name) {
      if (!name) return 'â€”';
      return name.replace('NVIDIA ', '');
    }

    function addLog(msg) {
      const container = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = '<span class="log-time">' + new Date().toLocaleTimeString() + '</span> ' + msg;
      container.insertBefore(entry, container.firstChild);
      if (container.children.length > 50) container.removeChild(container.lastChild);
    }

    // ---- Health v2 (mode banner) ----

    let eventTotalCount = 0;

    function handleHealthV2(data) {
      const banner = document.getElementById('healthBanner');
      if (!data || !data.mode) return;

      banner.style.display = 'block';
      // Remove previous mode classes
      banner.className = 'health-banner mode-' + data.mode;

      const modeLabels = {
        READY: 'READY',
        STARTING: 'STARTING',
        DEGRADED: 'DEGRADED',
        CRITICAL: 'CRITICAL',
        SHUTTING_DOWN: 'SHUTTING DOWN',
      };

      let html = '<span>' + (modeLabels[data.mode] || data.mode) + '</span>';
      if (data.conditions && data.conditions.length > 0) {
        html += '<div class="conditions">' + data.conditions.map(function(c) {
          return c.replace(/_/g, ' ');
        }).join(' &middot; ') + '</div>';
      }
      banner.innerHTML = html;

      // Also update the wall status badge in header
      const badge = document.getElementById('wallStatus');
      badge.style.display = 'inline-block';
      if (data.mode === 'READY') {
        badge.textContent = 'READY';
        badge.style.background = '#052e16'; badge.style.color = '#22c55e'; badge.style.border = '1px solid #166534';
      } else if (data.mode === 'DEGRADED') {
        badge.textContent = 'DEGRADED';
        badge.style.background = '#451a03'; badge.style.color = '#f59e0b'; badge.style.border = '1px solid #92400e';
      } else if (data.mode === 'CRITICAL') {
        badge.textContent = 'CRITICAL';
        badge.style.background = '#450a0a'; badge.style.color = '#ef4444'; badge.style.border = '1px solid #991b1b';
      } else if (data.mode === 'STARTING') {
        badge.textContent = 'STARTING';
        badge.style.background = '#172554'; badge.style.color = '#60a5fa'; badge.style.border = '1px solid #1e40af';
      } else {
        badge.textContent = data.mode;
        badge.style.background = '#1c1917'; badge.style.color = '#a8a29e'; badge.style.border = '1px solid #44403c';
      }

      // Update lease indicator if lease info comes with health (from server state)
      // Lease is managed separately via events/ack
    }

    // ---- Events Panel ----

    function appendEvent(event) {
      if (!event) return;
      eventTotalCount++;
      document.getElementById('eventCount').textContent = eventTotalCount + ' events';

      const container = document.getElementById('eventLogContainer');
      const entry = document.createElement('div');
      entry.className = 'event-entry';

      const severity = event.severity || 'INFO';
      const type = event.type || 'UNKNOWN';
      const details = event.details || {};
      const detailStr = Object.keys(details).length > 0
        ? Object.entries(details).map(function(kv) { return kv[0] + '=' + JSON.stringify(kv[1]); }).join(', ')
        : '';

      const time = event.ts ? new Date(event.ts).toLocaleTimeString() : new Date().toLocaleTimeString();

      entry.innerHTML =
        '<span class="event-time">' + time + '</span>' +
        '<span class="event-severity sev-' + severity + '">' + severity + '</span>' +
        '<span class="event-type">' + type + '</span>' +
        (detailStr ? '<span class="event-details">' + detailStr + '</span>' : '');

      container.insertBefore(entry, container.firstChild);
      // Cap at 100 entries
      while (container.children.length > 100) container.removeChild(container.lastChild);
    }

    // ---- Ack Feedback ----

    const pendingAcks = {};

    function handleAck(ack) {
      if (!ack || !ack.commandId) return;

      // Find if there's a pending command waiting for this ack
      const pending = pendingAcks[ack.commandId];
      if (pending && pending.statusEl) {
        const el = pending.statusEl;
        if (ack.status === 'RECEIVED') {
          el.textContent = 'Received...';
          el.style.color = '#60a5fa';
        } else if (ack.status === 'APPLIED') {
          el.textContent = 'Applied';
          el.style.color = '#22c55e';
          setTimeout(function() { el.textContent = ''; }, 3000);
          delete pendingAcks[ack.commandId];
        } else if (ack.status === 'REJECTED') {
          el.textContent = 'Rejected: ' + (ack.message || '');
          el.style.color = '#f59e0b';
          setTimeout(function() { el.textContent = ''; }, 5000);
          delete pendingAcks[ack.commandId];
        } else if (ack.status === 'FAILED') {
          el.textContent = 'Failed: ' + (ack.message || '');
          el.style.color = '#ef4444';
          setTimeout(function() { el.textContent = ''; }, 5000);
          delete pendingAcks[ack.commandId];
        } else if (ack.status === 'EXPIRED') {
          el.textContent = 'Expired';
          el.style.color = '#a8a29e';
          setTimeout(function() { el.textContent = ''; }, 3000);
          delete pendingAcks[ack.commandId];
        }
      }

      // Log all acks to the event log as well
      addLog('ACK [' + ack.status + '] ' + ack.commandId.slice(0, 16) + ': ' + (ack.message || ''));
    }

    // ---- Local WebSocket connection (when served from watchdog) ----

    let localWs = null;
    const isLocal = location.port === '3200';

    function connectLocal() {
      setStatus('connecting');
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      localWs = new WebSocket(proto + '//' + location.host + '/ws');

      localWs.onopen = function() {
        setStatus('connected');
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        if (!cpuRamChart) initCharts();
        addLog('Connected via local WebSocket');
      };

      localWs.onmessage = function(e) {
        if (!sessionStartTime) sessionStartTime = Date.now();
        try {
          const msg = JSON.parse(e.data);
          const msgBytes = e.data.length;
          totalBytes += msgBytes;
          totalMessages++;
          topicBytes[msg.type] = (topicBytes[msg.type] || 0) + msgBytes;
          topicMsgs[msg.type] = (topicMsgs[msg.type] || 0) + 1;
          updateThroughputUI();

          if (msg.type === 'telemetry') {
            messageCount++;
            updateDashboard(msg.data);
            pushHistory(msg.data);
          } else if (msg.type === 'command') {
            handleCommand(msg.data);
          } else if (msg.type === 'config') {
            handleConfig(msg.data);
          } else if (msg.type === 'health') {
            handleHealthV2(msg.data);
          } else if (msg.type === 'event') {
            appendEvent(msg.data);
          } else if (msg.type === 'ack') {
            handleAck(msg.data);
          } else if (msg.type === 'streaming') {
            updateStreamingUI(msg.data);
          } else if (msg.type === 'remoteStreaming') {
            updateRemoteStreamingUI(msg.data);
          }
        } catch {}
      };

      localWs.onclose = function() {
        setStatus('disconnected');
        addLog('Local WebSocket disconnected, reconnecting...');
        setTimeout(connectLocal, 2000);
      };

      localWs.onerror = function() {
        localWs.close();
      };
    }

    function startVuos() {
      var btn = document.getElementById('startBtn');
      btn.textContent = 'Starting...';
      btn.disabled = true;
      fetch('/api/start-vuos', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok && data.ack) {
            showAckOnBtn(btn, data.ack, 'Start Vu OS');
          } else if (data.ok) {
            setTimeout(function() { btn.textContent = 'Start Vu OS'; btn.disabled = false; }, 5000);
          } else {
            btn.textContent = 'Failed: ' + (data.error || data.ack && data.ack.message || 'unknown');
            btn.style.background = '#ef4444';
            setTimeout(function() { btn.textContent = 'Start Vu OS'; btn.disabled = false; btn.style.background = '#16a34a'; }, 3000);
          }
        })
        .catch(function() { btn.textContent = 'Start Vu OS'; btn.disabled = false; });
    }

    function restartVuos() {
      if (!confirm('Restart Vu One OS?')) return;
      var btn = document.getElementById('restartBtn');
      btn.textContent = 'Restarting...';
      btn.disabled = true;
      fetch('/api/restart-vuos', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok && data.ack) {
            showAckOnBtn(btn, data.ack, 'Restart Vu OS');
          } else if (data.ok) {
            setTimeout(function() { btn.textContent = 'Restart Vu OS'; btn.disabled = false; }, 5000);
          } else {
            btn.textContent = 'Failed: ' + (data.error || data.ack && data.ack.message || 'unknown');
            btn.style.background = '#ef4444';
            setTimeout(function() { btn.textContent = 'Restart Vu OS'; btn.disabled = false; btn.style.background = '#2563eb'; }, 3000);
          }
        })
        .catch(function() { btn.textContent = 'Restart Vu OS'; btn.disabled = false; });
    }

    function killWatchdog() {
      if (!confirm('Kill the watchdog process?')) return;
      var btn = document.getElementById('killBtn');
      btn.textContent = 'Shutting down...';
      btn.disabled = true;
      fetch('/api/quit', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            btn.textContent = 'Shutting down...';
          } else {
            btn.textContent = 'Failed: ' + (data.ack && data.ack.message || 'unknown');
            setTimeout(function() { btn.textContent = 'Kill Watchdog'; btn.disabled = false; }, 3000);
          }
        })
        .catch(function() { btn.textContent = 'Kill Watchdog'; btn.disabled = false; });
    }

    // --- Streaming ---
    function startStream() {
      var btn = document.getElementById('btnStartStream');
      btn.textContent = 'Starting...';
      btn.disabled = true;
      fetch('/api/stream-start', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            updateStreamingUI(data.state);
          } else {
            btn.textContent = 'Failed: ' + (data.error || 'unknown');
            btn.style.background = '#ef4444';
            setTimeout(function() { btn.textContent = 'Start Stream'; btn.disabled = false; btn.style.background = '#22c55e'; }, 3000);
          }
        })
        .catch(function(e) {
          btn.textContent = 'Error';
          setTimeout(function() { btn.textContent = 'Start Stream'; btn.disabled = false; btn.style.background = '#22c55e'; }, 3000);
        });
    }

    function stopStream() {
      var btn = document.getElementById('btnStopStream');
      btn.textContent = 'Stopping...';
      btn.disabled = true;
      fetch('/api/stream-stop', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          updateStreamingUI(data.state || { status: 'stopped' });
        })
        .catch(function() {
          btn.textContent = 'Stop Stream';
          btn.disabled = false;
        });
    }

    function updateStreamingUI(state) {
      var statusEl = document.getElementById('streamStatus');
      var uptimeEl = document.getElementById('streamUptime');
      var portEl = document.getElementById('streamPort');
      var startBtn = document.getElementById('btnStartStream');
      var stopBtn = document.getElementById('btnStopStream');
      var viewerLink = document.getElementById('streamViewerLink');
      var notAvailable = document.getElementById('streamNotAvailable');

      // Show/hide not available warning
      if (state.available === false) {
        notAvailable.style.display = 'block';
        startBtn.disabled = true;
        startBtn.style.opacity = '0.5';
      } else {
        notAvailable.style.display = 'none';
        startBtn.style.opacity = '1';
      }

      statusEl.textContent = state.status || 'stopped';
      statusEl.className = 'metric-value ' + (state.status === 'running' ? 'good' : state.status === 'error' ? 'danger' : '');

      if (state.port) portEl.textContent = state.port;

      if (state.status === 'running') {
        startBtn.style.display = 'none';
        stopBtn.style.display = '';
        stopBtn.textContent = 'Stop Stream';
        stopBtn.disabled = false;
        viewerLink.style.display = '';
        // Build viewer URL - use current hostname with streaming port
        var host = window.location.hostname || 'localhost';
        viewerLink.href = 'http://' + host + ':' + (state.port || 8000) + '/webrtcstreamer.html?video=desktop';

        // Update uptime
        if (state.startedAt) {
          var uptime = Math.floor((Date.now() - state.startedAt) / 1000);
          uptimeEl.textContent = formatUptime(uptime);
        }
      } else {
        startBtn.style.display = '';
        startBtn.textContent = 'Start Stream';
        startBtn.disabled = state.available === false;
        stopBtn.style.display = 'none';
        viewerLink.style.display = 'none';
        uptimeEl.textContent = 'â€”';
      }

      if (state.error) {
        statusEl.textContent = state.error;
      }
    }

    function formatUptime(seconds) {
      if (seconds < 60) return seconds + 's';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ' + (seconds % 60) + 's';
      var h = Math.floor(seconds / 3600);
      var m = Math.floor((seconds % 3600) / 60);
      return h + 'h ' + m + 'm';
    }

    // --- Remote Streaming (VDO.ninja Bridge) ---
    function startRemoteStream() {
      var btn = document.getElementById('btnStartRemote');
      btn.textContent = 'Connecting...';
      btn.disabled = true;
      fetch('/api/remote-stream-start', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            updateRemoteStreamingUI(data);
          } else {
            btn.textContent = 'Failed';
            document.getElementById('remoteError').textContent = data.error || 'Unknown error';
            document.getElementById('remoteError').style.display = 'block';
            setTimeout(function() { btn.textContent = 'Enable Remote'; btn.disabled = false; }, 3000);
          }
        })
        .catch(function(e) {
          btn.textContent = 'Error';
          setTimeout(function() { btn.textContent = 'Enable Remote'; btn.disabled = false; }, 3000);
        });
    }

    function stopRemoteStream() {
      var btn = document.getElementById('btnStopRemote');
      btn.textContent = 'Stopping...';
      btn.disabled = true;
      fetch('/api/remote-stream-stop', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          updateRemoteStreamingUI(data);
        })
        .catch(function() {
          btn.textContent = 'Disable Remote';
          btn.disabled = false;
        });
    }

    function updateRemoteStreamingUI(state) {
      var statusEl = document.getElementById('remoteStatus');
      var startBtn = document.getElementById('btnStartRemote');
      var stopBtn = document.getElementById('btnStopRemote');
      var urlRow = document.getElementById('remoteUrlRow');
      var urlInput = document.getElementById('remoteViewerUrl');
      var viewersRow = document.getElementById('remoteViewersRow');
      var viewerCountEl = document.getElementById('remoteViewerCount');
      var errorEl = document.getElementById('remoteError');
      var requiresLocalEl = document.getElementById('remoteRequiresLocal');

      statusEl.textContent = state.status || 'disconnected';
      if (state.status === 'connected') {
        statusEl.className = 'metric-value good';
      } else if (state.status === 'error') {
        statusEl.className = 'metric-value danger';
      } else if (state.status === 'connecting') {
        statusEl.className = 'metric-value warning';
      } else {
        statusEl.className = 'metric-value';
      }

      if (state.status === 'connected') {
        startBtn.style.display = 'none';
        stopBtn.style.display = '';
        stopBtn.textContent = 'Disable Remote';
        stopBtn.disabled = false;
        urlRow.style.display = 'block';
        urlInput.value = state.viewerUrl || '';
        viewersRow.style.display = '';
        viewerCountEl.textContent = state.viewerCount || 0;
        errorEl.style.display = 'none';
        requiresLocalEl.style.display = 'none';
      } else {
        startBtn.style.display = '';
        startBtn.textContent = 'Enable Remote';
        startBtn.disabled = false;
        stopBtn.style.display = 'none';
        urlRow.style.display = 'none';
        viewersRow.style.display = 'none';
        // Show "requires local" hint if local streaming not running
        var streamStatus = document.getElementById('streamStatus');
        if (streamStatus && streamStatus.textContent !== 'running') {
          requiresLocalEl.style.display = 'block';
          startBtn.style.opacity = '0.6';
        } else {
          requiresLocalEl.style.display = 'none';
          startBtn.style.opacity = '1';
        }
      }

      if (state.error) {
        errorEl.textContent = state.error;
        errorEl.style.display = 'block';
      } else {
        errorEl.style.display = 'none';
      }
    }

    function copyRemoteUrl(btn) {
      var input = document.getElementById('remoteViewerUrl');
      input.select();
      navigator.clipboard.writeText(input.value).then(function() {
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
      });
    }

    function showAckOnBtn(btn, ack, originalText) {
      if (ack.status === 'APPLIED') {
        btn.textContent = 'Applied';
        btn.style.background = '#16a34a';
      } else if (ack.status === 'REJECTED') {
        btn.textContent = 'Rejected: ' + (ack.message || '');
        btn.style.background = '#f59e0b';
      } else {
        btn.textContent = ack.status + ': ' + (ack.message || '');
      }
      setTimeout(function() {
        btn.textContent = originalText;
        btn.disabled = false;
        // Reset background based on button
        if (btn.id === 'startBtn') btn.style.background = '#16a34a';
        else if (btn.id === 'restartBtn') btn.style.background = '#2563eb';
        else if (btn.id === 'killBtn') btn.style.background = '#dc2626';
      }, 4000);
    }

    // Auto-connect on load â€” local WS if served from watchdog, MQTT otherwise
    window.addEventListener('DOMContentLoaded', () => {
      if (isLocal) {
        document.getElementById('remoteControls').style.display = 'none';
        document.getElementById('restartBtn').style.display = '';
        document.getElementById('killBtn').style.display = '';
        connectLocal();
      } else {
        // Default broker list for remote mode
        if (!window._mqttBrokers) {
          window._mqttBrokers = [
            { id: 'emqx', label: 'Vu Studio (EMQX)', url: 'wss://c9b6cc55.ala.us-east-1.emqxsl.com:8084/mqtt', username: 'dev', password: 'testing' },
            { id: 'railway', label: 'Railway', url: 'wss://mqtt.vu.studio/mqtt', username: 'dev', password: 'testing' }
          ];
          populateBrokerSelect('emqx');
        }
        connect();
      }
    });
  </script>
</body>
</html>
